# AI 실내 공간 전후 변화 분석 시스템 - Database

시스템의 핵심 데이터 저장소 및 스키마 관리를 담당하는 데이터베이스 파트입니다.

## README 유지 규칙 (AI/사람 공통)

> [DO NOT REMOVE] 아래 9개 섹션 제목은 뼈대로 유지하되 4, 5, 6번은 파트에 맞게 적용됨:
> `기술스택`, `프로젝트 구조`, `설치 및 실행`, `테이블/뷰/프로시저 목록`, `접근 권한/계정 정책`, `스키마 정의(DDL/ERD 기준)`, `개발 가이드`, `테스트`, `라이센스`
>
> [DO NOT REMOVE] 각 섹션의 `포함해야 함` / `포함하지 말 것` 블록은 삭제 금지.
>
> [DO NOT REMOVE] README에는 "현재 동작하는 사실"만 기록. 기획/논의/회의록/로드맵 상세는 `docs/` 또는 별도 문서로 분리.

---

## 1) 기술스택

```text
[포함해야 함]
- 실제 사용 중인 DBMS 제품 및 버전
- 관리 도구(Docker, Migration Tool 등)
- 데이터 모델링 도구

[포함하지 말 것]
- 타 DBMS와의 장단점 비교 등 기술 배경
- 도입 검토 중인 미확정 솔루션

[업데이트 트리거]
- PostgreSQL/MySQL 등 엔진 버전 업그레이드 시
- Docker 이미지 설정이나 환경 변수 체계 변경 시
```

### 현재 사용
- DBMS: PostgreSQL 17 (Docker 기반)
- 관리 도구: `docker-compose`
- 마이그레이션: Alembic (백엔드와 연동)
- 모델링: DBML, MySQL Workbench (초기 설계용)

---

## 2) 프로젝트 구조

```text
[포함해야 함]
- DB 설정 파일, DDL 스크립트, 데이터 에셋 저장 경로
- ERD 이미지 및 정의서 파일 위치

[포함하지 말 것]
- DBMS 내부 시스템 파일 설명
- 실제 데이터 파일(pg_data 등) 상세 내역

[업데이트 트리거]
- `DB/` 내 디렉토리 구조 변경 시
- 새로운 설계 문서나 정의서가 추가될 때
```

```text
DB/
├── ERD-img/            # ERD 히스토리 및 최신 이미지
├── mysql_data/         # (레거시/참고용) MySQL 데이터
├── pg_data/            # PostgreSQL 데이터 (Git 제외)
├── 다방록.dbml         # 데이터베이스 모델링 언어 파일
├── 다방록_테이블정의서.md # 컬럼 상세 명세
├── 다방록_MySQL_DDL.sql # 초기 생성용 SQL 스크립트
├── docker-compose.yml  # DB 컨테이너 설정
└── README.md
```

---

## 3) 설치 및 실행

```text
[포함해야 함]
- 컨테이너 구동 방법 및 접속 정보
- 초기 데이터(Seed) 주입 방법

[포함하지 말 것]
- 운영 서버의 백업/복구 상세 시나리오
- 복잡한 튜닝 가이드

[업데이트 트리거]
- `docker-compose.yml` 포트나 볼륨 설정 변경 시
- 초기 계정 정보나 DB 이름 변경 시
```

### 1. 컨테이너 실행

`DB/` 디렉토리에서 실행:

```bash
docker-compose up -d
```

### 2. 접속 정보

- Host: `localhost`
- Port: `5432`
- User: `postgres` (또는 .env 설정값)
- DB Name: `hct_db`

---

## 4) 테이블/뷰/프로시저 목록

```text
[포함해야 함]
- 현재 운영 중인 주요 테이블 목록 및 용도
- 사용 중인 View 또는 Store Procedure가 있다면 그 역할

[포함하지 말 것]
- 임시 테이블이나 백업용 테이블
- 마이그레이션 관리용 테이블(alembic_version 등)

[업데이트 트리거]
- `CREATE TABLE` 등으로 신규 테이블 추가 시
- 비즈니스 로직에 핵심적인 View/Procedure 생성 시
```

### 주요 테이블
- `users`: 사용자 계정 정보
- `projects`: 공간 분석 프로젝트 단위
- `space_images`: 업로드된 원본 공간 이미지 (전/후)
- `analysis_jobs`: AI 분석 작업 상태 및 이력
- `analysis_results`: 객체 변화 감지 결과 데이터
- `metrics`: 면적, 수량 등 수치 데이터
- `analyzed_images`: AI가 분석 표시(Bounding Box 등)를 한 결과 이미지 정보
- `reports`: 최종 생성된 리포트 메타데이터

---

## 5) 접근 권한/계정 정책

```text
[포함해야 함]
- 개발/운영 환경별 계정 분리 여부
- 특정 테이블에 대한 읽기/쓰기 권한 제한 정책

[포함하지 말 것]
- 실제 비밀번호 (환경 변수 파일에만 기재)
- 네트워크 방화벽 등 인프라 보안 정책 전체

[업데이트 트리거]
- 새로운 DB 계정 추가 또는 권한 변경 시
- SSL 접속 필수 정책 도입 등 보안 규칙 변경 시
```

- **관리자 계정**: `postgres` (전체 권한)
- **애플리케이션 계정**: `hct_user` (DML 중심 권한 부여 예정)
- **정책**: 외부망 직접 접속 차단, 내부 컨테이너 통신 권장

---

## 6) 스키마 정의(DDL/ERD 기준)

```text
[포함해야 함]
- 최신 ERD 파일 경로 링크
- 핵심 관계 구조(Foreign Key 관계) 설명

[포함하지 말 것]
- 수백 줄의 SQL DDL 전문 직접 기재 (파일 링크로 대체)
- 개별 컬럼의 타입 나열 (정의서로 대체)

[업데이트 트리거]
- 테이블 간 관계(1:N 등)가 변경되거나 추가될 때
- ERD 파일이 업데이트되어 새로운 스크린샷이 나올 때
```

### ERD 정보
- 최신 ERD 이미지: `DB/ERD-img/다방록_ERD_v0.02_0204.png`
- 상세 정의서: `DB/다방록_테이블정의서.md`

### 핵심 구조 요약
- `users` → `projects` (1:N)
- `projects` → `space_images` (1:N)
- `projects` → `analysis_jobs` (1:N)
- `analysis_jobs` → `reports` (1:1)

---

## 7) 개발 가이드

```text
[포함해야 함]
- 신규 테이블 추가 시의 프로세스(Alembic 사용 등)
- SQL 쿼리 작성 시 주의사항(Naming Convention 등)

[포함하지 말 것]
- 범용적인 SQL 문법 가이드
- 이전 개발 방식 히스토리

[업데이트 트리거]
- 네이밍 컨벤션 변경 시
- 마이그레이션 워크플로우 변경 시
```

- **네이밍 규칙**: 테이블명은 복수형(`users`), 스네이크 케이스(`snake_case`) 사용
- **스키마 변경**: 백엔드의 `Alembic`을 통해 마이그레이션 수행 필수 (직접 SQL 실행 지양)

---

## 8) 테스트

```text
[포함해야 함]
- 데이터 무결성 검증 방법
- 더미 데이터 생성 스크립트 사용법

[포함하지 말 것]
- 백엔드 API 테스트와 중복되는 내용
- 일회성 수동 쿼리 기록

[업데이트 트리거]
- 테스트용 데이터셋 스키마가 바뀔 때
- DB 제약조건(Constraint) 테스트 추가 시
```

- **데이터 검증**: `alembic check`를 통한 모델-DB 동기화 확인
- **샘플 데이터**: `DB/다방록_MySQL_DDL.sql` 내의 예시 데이터를 환경에 맞게 변환하여 활용

---

## 9) 라이센스

```text
[포함해야 함]
- 데이터 및 스키마에 대한 라이센스

[업데이트 트리거]
- 프로젝트 라이센스 정책 변경 시
```

MIT License
